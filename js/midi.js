// MIDI.js 
//
// 100% JavaScript MIDI File Player using W3C Web Audio API 
// with fallbacks for older browsers
// 
// Copyrights Johannes Feulner, Karlsruhe, Germany, 2014. All rights reserved.
// Contact: weblily@weblily.net
//
!function(a){function n(){var f,g,h,b=(navigator.appVersion,navigator.userAgent),c=navigator.appName,d=""+parseFloat(navigator.appVersion),e=parseInt(navigator.appVersion,10);(g=b.indexOf("Opera"))!=-1?(c="Opera",d=b.substring(g+6),(g=b.indexOf("Version"))!=-1&&(d=b.substring(g+8))):(g=b.indexOf("MSIE"))!=-1?(c="Microsoft Internet Explorer",d=b.substring(g+5)):(g=b.indexOf("Trident"))!=-1?(c="Microsoft Internet Explorer",d=(g=b.indexOf("rv:"))!=-1?b.substring(g+3):"0.0"):(g=b.indexOf("Chrome"))!=-1?(c="Chrome",d=b.substring(g+7)):(g=b.indexOf("Android"))!=-1?(c="Android",d=b.substring(g+8)):(g=b.indexOf("Safari"))!=-1?(c="Safari",d=b.substring(g+7),(g=b.indexOf("Version"))!=-1&&(d=b.substring(g+8))):(g=b.indexOf("Firefox"))!=-1?(c="Firefox",d=b.substring(g+8)):(f=b.lastIndexOf(" ")+1)<(g=b.lastIndexOf("/"))&&(c=b.substring(f,g),d=b.substring(g+1),c.toLowerCase()==c.toUpperCase()&&(c=navigator.appName)),(h=d.indexOf(";"))!=-1&&(d=d.substring(0,h)),(h=d.indexOf(" "))!=-1&&(d=d.substring(0,h)),e=parseInt(""+d,10),isNaN(e)&&(d=""+parseFloat(navigator.appVersion),e=parseInt(navigator.appVersion,10));var i=new Object;return i.browserName=c,i.fullVersion=d,i.majorVersion=e,i.appName=navigator.appName,i.userAgent=navigator.userAgent,i.platform=navigator.platform,i}function o(a,b){var c=document.getElementsByTagName("script")[0],d=document.createElement("script");d.onreadystatechange=function(){"loaded"!==d.readyState&&"complete"!==d.readyState||(d.onreadystatechange=null,b())},d.onload=function(){b()},d.onerror=function(){MIDIjs.message_callback("Error: Cannot load  JavaScript filet "+a)},d.src=a,d.type="text/javascript",c.parentNode.insertBefore(d,c)}function p(a){var b=new Object;if(b.time=c.currentTime-l,MIDIjs.player_callback(b),h=Module.ccall("mid_song_read_wave","number",["number","number","number","number"],[j,f,2*e,!1]),0==h)return void u();for(var d=Math.pow(2,15),g=0;g<e;g++)g<h?a.outputBuffer.getChannelData(0)[g]=Module.getValue(f+2*g,"i16")/d:(MIDIjs.message_callback("Filling 0 at end of buffer"),a.outputBuffer.getChannelData(0)[g]=0)}function q(a,b,h){var i=new XMLHttpRequest;i.open("GET",b+h,!0),i.responseType="arraybuffer",i.onerror=function(){MIDIjs.message_callback("Error: Cannot retrieve patch file "+b+h)},i.onload=function(){if(200!=i.status)return void MIDIjs.message_callback("Error: Cannot retrieve patch filee "+b+h+" : "+i.status);if(num_missing--,FS.createDataFile("pat/",h,new Int8Array(i.response),!0,!0),MIDIjs.message_callback("Loading instruments: "+num_missing),0==num_missing){stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[g,midiFileArray.length,!1]);var k=32784,m=Module.ccall("mid_create_options","number",["number","number","number","number"],[c.sampleRate,k,1,2*e]);j=Module.ccall("mid_song_load","number",["number","number"],[stream,m]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),Module.ccall("mid_song_start","void",["number"],[j]),d=c.createScriptProcessor(e,0,1),f=Module._malloc(2*e),d.onaudioprocess=p,d.connect(c.destination),l=c.currentTime,MIDIjs.message_callback("Playing: "+a+" ...")}},i.send()}function r(){var a=c.createBuffer(1,44100,44100);for(freq=440,i=0;i<48e3;i++)a.getChannelData(0)[i]=0;var b=c.createBufferSource();b.buffer=a,b.connect(c.destination),b.start(0)}function s(a){u();for(var b="",c=0;c<document.scripts.length;c++){var d=document.scripts[c].src,e=d.lastIndexOf("midi.js");if(e==d.length-7){k=d.substr(0,e),b=k+"libtimidity.js";break}}for(var c=0;c<document.scripts.length;c++){var d=document.scripts[c].src;if(b==d)return void t(a)}MIDIjs.message_callback("Loading libtimidity ... "),"iPad"!=navigator.platform&&"iPhone"!=navigator.platform&&"iPod"!=navigator.platform||r(),o(b,function(){t(a)})}function t(a){MIDIjs.message_callback("Loading MIDI file "+a+" ...");var b=new XMLHttpRequest;b.open("GET",a,!0),b.responseType="arraybuffer",b.onerror=function(){MIDIjs.message_callback("Error: Cannot retrieve MIDI file "+a)},b.onload=function(){if(200!=b.status)return void MIDIjs.message_callback("Error: Cannot retrieve MIDI file "+a+" : "+b.status);MIDIjs.message_callback("MIDI file loaded: "+a),midiFileArray=new Int8Array(b.response),g=Module._malloc(midiFileArray.length),Module.writeArrayToMemory(midiFileArray,g),rval=Module.ccall("mid_init","number",[],[]),stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[g,midiFileArray.length,!1]);var h=32784,i=Module.ccall("mid_create_options","number",["number","number","number","number"],[c.sampleRate,h,1,2*e]);if(j=Module.ccall("mid_song_load","number",["number","number"],[stream,i]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),num_missing=Module.ccall("mid_song_get_num_missing_instruments","number",["number"],[j]),0<num_missing)for(var m=0;m<num_missing;m++){var n=Module.ccall("mid_song_get_missing_instrument","string",["number","number"],[j,m]);q(a,k+"pat/",n)}else Module.ccall("mid_song_start","void",["number"],[j]),d=c.createScriptProcessor(e,0,1),f=Module._malloc(2*e),d.onaudioprocess=p,d.connect(c.destination),l=c.currentTime,MIDIjs.message_callback("Playing: "+a+" ...")},b.send()}function u(){d&&(d.disconnect(),d.onaudioprocess=0,d=0,Module._free(f),Module._free(g),Module.ccall("mid_song_free","void",["number"],[j]),j=0,Module.ccall("mid_exit","void",[],[]),d=0),MIDIjs.message_callback(m);var a=new Object;a.time=0,MIDIjs.player_callback(a)}function v(a){w();var b=document.getElementById("scorioMIDI");b?b.lastChild.setAttribute("src",a):(b=document.createElement("div"),b.setAttribute("id","scorioMIDI"),b.innerHTML='&nbsp;<bgsound src="'+a+'" volume="100"/>',document.body.appendChild(b)),d=b,MIDIjs.message_callback("Playing "+a+" ...")}function w(){if(d){var a=d;a.lastChild.setAttribute("src","midi/silence.mid"),d=0}MIDIjs.message_callback(m)}function x(a){y();var b=document.getElementById("scorioMIDI");b?b.lastChild.setAttribute("data",a):(b=document.createElement("div"),b.setAttribute("id","scorioMIDI"),b.innerHTML='<object data="'+a+'" autostart="true" volume="100" type="audio/mid"></object>',document.body.appendChild(b)),d=b,MIDIjs.message_callback("Playing "+a+" ...")}function y(){if(d){var a=d;a.parentNode.removeChild(a),d=0}MIDIjs.message_callback(m)}var b,f,g,c=0,d=0,e=8192,h=0,j=0,k="",l=0,m="",z=n();try{("iPhone"==z.platform||"iPod"==z.platform||"iPad"==z.platform)&&z.majorVersion<=6?b="none":(window.AudioContext=window.AudioContext||window.webkitAudioContext,c=new AudioContext,b="WebAudioAPI")}catch(a){b="Microsoft Internet Explorer"==z.browserName?"bgsound":"Android"==z.browserName?"none":"object"}a.MIDIjs=new Object,a.MIDIjs.message_callback=function(a){console.log(a)},a.MIDIjs.player_callback=function(a){},a.MIDIjs.get_audio_status=function(){return m},a.MIDIjs.unmute_iOS_hack=r,"WebAudioAPI"==b?(a.MIDIjs.play=s,a.MIDIjs.stop=u,m="audioMethod: WebAudioAPI, sampleRate (Hz): "+c.sampleRate+", audioBufferSize (Byte): "+e):"bgsound"==b?(a.MIDIjs.play=v,a.MIDIjs.stop=w,m="audioMethod: &lt;bgsound&gt;"):"object"==b?(a.MIDIjs.play=x,a.MIDIjs.stop=y,m="audioMethod: &lt;object&gt;"):(a.MIDIjs.play=function(a){},a.MIDIjs.stop=function(a){},m="audioMethod: No method found")}(this);!function(a){function n(){var f,g,h,b=(navigator.appVersion,navigator.userAgent),c=navigator.appName,d=""+parseFloat(navigator.appVersion),e=parseInt(navigator.appVersion,10);(g=b.indexOf("Opera"))!=-1?(c="Opera",d=b.substring(g+6),(g=b.indexOf("Version"))!=-1&&(d=b.substring(g+8))):(g=b.indexOf("MSIE"))!=-1?(c="Microsoft Internet Explorer",d=b.substring(g+5)):(g=b.indexOf("Trident"))!=-1?(c="Microsoft Internet Explorer",d=(g=b.indexOf("rv:"))!=-1?b.substring(g+3):"0.0"):(g=b.indexOf("Chrome"))!=-1?(c="Chrome",d=b.substring(g+7)):(g=b.indexOf("Android"))!=-1?(c="Android",d=b.substring(g+8)):(g=b.indexOf("Safari"))!=-1?(c="Safari",d=b.substring(g+7),(g=b.indexOf("Version"))!=-1&&(d=b.substring(g+8))):(g=b.indexOf("Firefox"))!=-1?(c="Firefox",d=b.substring(g+8)):(f=b.lastIndexOf(" ")+1)<(g=b.lastIndexOf("/"))&&(c=b.substring(f,g),d=b.substring(g+1),c.toLowerCase()==c.toUpperCase()&&(c=navigator.appName)),(h=d.indexOf(";"))!=-1&&(d=d.substring(0,h)),(h=d.indexOf(" "))!=-1&&(d=d.substring(0,h)),e=parseInt(""+d,10),isNaN(e)&&(d=""+parseFloat(navigator.appVersion),e=parseInt(navigator.appVersion,10));var i=new Object;return i.browserName=c,i.fullVersion=d,i.majorVersion=e,i.appName=navigator.appName,i.userAgent=navigator.userAgent,i.platform=navigator.platform,i}function o(a,b){var c=document.getElementsByTagName("script")[0],d=document.createElement("script");d.onreadystatechange=function(){"loaded"!==d.readyState&&"complete"!==d.readyState||(d.onreadystatechange=null,b())},d.onload=function(){b()},d.onerror=function(){MIDIjs.message_callback("Error: Cannot load  JavaScript filet "+a)},d.src=a,d.type="text/javascript",c.parentNode.insertBefore(d,c)}function p(a){var b=new Object;if(b.time=c.currentTime-l,MIDIjs.player_callback(b),h=Module.ccall("mid_song_read_wave","number",["number","number","number","number"],[j,f,2*e,!1]),0==h)return void u();for(var d=Math.pow(2,15),g=0;g<e;g++)g<h?a.outputBuffer.getChannelData(0)[g]=Module.getValue(f+2*g,"i16")/d:(MIDIjs.message_callback("Filling 0 at end of buffer"),a.outputBuffer.getChannelData(0)[g]=0)}function q(a,b,h){var i=new XMLHttpRequest;i.open("GET",b+h,!0),i.responseType="arraybuffer",i.onerror=function(){MIDIjs.message_callback("Error: Cannot retrieve patch file "+b+h)},i.onload=function(){if(200!=i.status)return void MIDIjs.message_callback("Error: Cannot retrieve patch filee "+b+h+" : "+i.status);if(num_missing--,FS.createDataFile("pat/",h,new Int8Array(i.response),!0,!0),MIDIjs.message_callback("Loading instruments: "+num_missing),0==num_missing){stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[g,midiFileArray.length,!1]);var k=32784,m=Module.ccall("mid_create_options","number",["number","number","number","number"],[c.sampleRate,k,1,2*e]);j=Module.ccall("mid_song_load","number",["number","number"],[stream,m]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),Module.ccall("mid_song_start","void",["number"],[j]),d=c.createScriptProcessor(e,0,1),f=Module._malloc(2*e),d.onaudioprocess=p,d.connect(c.destination),l=c.currentTime,MIDIjs.message_callback("Playing: "+a+" ...")}},i.send()}function r(){var a=c.createBuffer(1,44100,44100);for(freq=440,i=0;i<48e3;i++)a.getChannelData(0)[i]=0;var b=c.createBufferSource();b.buffer=a,b.connect(c.destination),b.start(0)}function s(a){u();for(var b="",c=0;c<document.scripts.length;c++){var d=document.scripts[c].src,e=d.lastIndexOf("midi.js");if(e==d.length-7){k=d.substr(0,e),b=k+"libtimidity.js";break}}for(var c=0;c<document.scripts.length;c++){var d=document.scripts[c].src;if(b==d)return void t(a)}MIDIjs.message_callback("Loading libtimidity ... "),"iPad"!=navigator.platform&&"iPhone"!=navigator.platform&&"iPod"!=navigator.platform||r(),o(b,function(){t(a)})}function t(a){MIDIjs.message_callback("Loading MIDI file "+a+" ...");var b=new XMLHttpRequest;b.open("GET",a,!0),b.responseType="arraybuffer",b.onerror=function(){MIDIjs.message_callback("Error: Cannot retrieve MIDI file "+a)},b.onload=function(){if(200!=b.status)return void MIDIjs.message_callback("Error: Cannot retrieve MIDI file "+a+" : "+b.status);MIDIjs.message_callback("MIDI file loaded: "+a),midiFileArray=new Int8Array(b.response),g=Module._malloc(midiFileArray.length),Module.writeArrayToMemory(midiFileArray,g),rval=Module.ccall("mid_init","number",[],[]),stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[g,midiFileArray.length,!1]);var h=32784,i=Module.ccall("mid_create_options","number",["number","number","number","number"],[c.sampleRate,h,1,2*e]);if(j=Module.ccall("mid_song_load","number",["number","number"],[stream,i]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),num_missing=Module.ccall("mid_song_get_num_missing_instruments","number",["number"],[j]),0<num_missing)for(var m=0;m<num_missing;m++){var n=Module.ccall("mid_song_get_missing_instrument","string",["number","number"],[j,m]);q(a,k+"pat/",n)}else Module.ccall("mid_song_start","void",["number"],[j]),d=c.createScriptProcessor(e,0,1),f=Module._malloc(2*e),d.onaudioprocess=p,d.connect(c.destination),l=c.currentTime,MIDIjs.message_callback("Playing: "+a+" ...")},b.send()}function u(){d&&(d.disconnect(),d.onaudioprocess=0,d=0,Module._free(f),Module._free(g),Module.ccall("mid_song_free","void",["number"],[j]),j=0,Module.ccall("mid_exit","void",[],[]),d=0),MIDIjs.message_callback(m);var a=new Object;a.time=0,MIDIjs.player_callback(a)}function v(a){w();var b=document.getElementById("scorioMIDI");b?b.lastChild.setAttribute("src",a):(b=document.createElement("div"),b.setAttribute("id","scorioMIDI"),b.innerHTML='&nbsp;<bgsound src="'+a+'" volume="100"/>',document.body.appendChild(b)),d=b,MIDIjs.message_callback("Playing "+a+" ...")}function w(){if(d){var a=d;a.lastChild.setAttribute("src","midi/silence.mid"),d=0}MIDIjs.message_callback(m)}function x(a){y();var b=document.getElementById("scorioMIDI");b?b.lastChild.setAttribute("data",a):(b=document.createElement("div"),b.setAttribute("id","scorioMIDI"),b.innerHTML='<object data="'+a+'" autostart="true" volume="100" type="audio/mid"></object>',document.body.appendChild(b)),d=b,MIDIjs.message_callback("Playing "+a+" ...")}function y(){if(d){var a=d;a.parentNode.removeChild(a),d=0}MIDIjs.message_callback(m)}var b,f,g,c=0,d=0,e=8192,h=0,j=0,k="",l=0,m="",z=n();try{("iPhone"==z.platform||"iPod"==z.platform||"iPad"==z.platform)&&z.majorVersion<=6?b="none":(window.AudioContext=window.AudioContext||window.webkitAudioContext,c=new AudioContext,b="WebAudioAPI")}catch(a){b="Microsoft Internet Explorer"==z.browserName?"bgsound":"Android"==z.browserName?"none":"object"}a.MIDIjs=new Object,a.MIDIjs.message_callback=function(a){console.log(a)},a.MIDIjs.player_callback=function(a){},a.MIDIjs.get_audio_status=function(){return m},a.MIDIjs.unmute_iOS_hack=r,"WebAudioAPI"==b?(a.MIDIjs.play=s,a.MIDIjs.stop=u,m="audioMethod: WebAudioAPI, sampleRate (Hz): "+c.sampleRate+", audioBufferSize (Byte): "+e):"bgsound"==b?(a.MIDIjs.play=v,a.MIDIjs.stop=w,m="audioMethod: &lt;bgsound&gt;"):"object"==b?(a.MIDIjs.play=x,a.MIDIjs.stop=y,m="audioMethod: &lt;object&gt;"):(a.MIDIjs.play=function(a){},a.MIDIjs.stop=function(a){},m="audioMethod: No method found")}(this);
